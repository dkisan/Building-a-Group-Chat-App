<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp</title>
    <style>
        .lst {
            line-height: 2;
        }
    </style>
</head>

<body style="margin: 0; padding: 0;">

    <div style="display: flex; flex-direction: column; flex: 1;">
        <h1 style="text-align: center; text-decoration: underline;" id="chatwindowname">All Chat</h1>
        <div style="display: flex;">
            <div style="padding: 1em; border-right: 1px solid black; margin-bottom: 7vh; gap: 1rem;">
                <button style="margin-bottom: 10px;" id="creatgroup"> Create a Group </button>
                <form action="#" style="display: none;" id="groupid" onsubmit="createGroupHandler(event)">
                    <input type="text" id="groupnameid">
                    <button type="submit">Create</button>
                </form>
                <hr>
                <div id="grplist" style="display: flex; flex-direction: column; gap: 1vh;">
                </div>
            </div>
            <ul style="flex: 1; list-style-type: none; margin-bottom: 7vh; border-right: 1px solid black;" id="chatid">
            </ul>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
            <button
                style="width: max-content; display: none; padding: 10px; background-color: aquamarine; border: 1px solid aqua; cursor: pointer;"
                id="addbtn">Add
                People to Group</button>
            <div id="addtogrp" style="display: none; align-items: center; gap: 15px;">
                <ul style="list-style-type: none; display: flex; flex-direction: column; gap: 10px;width: 30vh; height: 30vh; overflow-y: auto;"
                    id="alluserlist"></ul>
            </div>
        </div>
        <div
            style="display: flex; background-color: blue; padding-top: 10px; padding-bottom: 10px; position: fixed; bottom: 0; width: 100vw; justify-content: center; align-items: center; overflow: hidden;">
            <input style="line-height: 2; width: 50vw;" type="text" name="" id="allchatid">
            <button style="line-height: 2;" onclick="allchatHandler(event)">Send</button>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>

    <script>
        const chatid = document.getElementById('chatid')
        const allchat = document.getElementById('allchatid')
        const groupform = document.getElementById('groupid')
        const groupname = document.getElementById('groupnameid')
        const grplist = document.getElementById('grplist')

        let intval;

        document.getElementById('addbtn').addEventListener('click', async () => {
            groupform.style.display = 'none'
            document.getElementById('addtogrp').style.display = 'flex'
            document.getElementById('addtogrp').style.flexDirection = 'column'

            const users = await axios.get(`/chat/getusers`)
            if (users.data) {
                while (document.getElementById('alluserlist').firstChild) {
                    document.getElementById('alluserlist').removeChild(document.getElementById('alluserlist').firstChild)
                }
                users.data.map(u => {
                    showUsers(u.name, u.email)
                })
            }

        })

        function showUsers(name, email) {
            const li = document.createElement('li')
            li.appendChild(document.createTextNode(`${name}`))
            li.setAttribute('id', email)
            const btn = document.createElement('button')
            btn.appendChild(document.createTextNode('+'))
            btn.setAttribute('onclick', 'addtogroupHandler(event)')
            btn.style.marginLeft = '10px'
            li.appendChild(btn)
            document.getElementById('alluserlist').appendChild(li)
        }

        async function addtogroupHandler(e) {
            const addId = e.target.parentElement.getAttribute('id')
            const isAdded = await axios.post(`/chat/group/addtogroup`, {
                grpid: localStorage.getItem('chatgrpid'),
                pplid: addId,
                uid: localStorage.getItem('chatuid')
            })
            if (isAdded.status === 200) {
                alert(isAdded.data.message)
            } else {
                alert('some error occured')
            }
        }

        document.getElementById('creatgroup').addEventListener('click', () => {
            groupform.style.display = 'block'
            document.getElementById('addtogrp').style.display = 'none'
        })

        async function createGroupHandler(e) {
            e.preventDefault()
            const group = await axios.post(`/chat/group/create`, {
                groupname: groupname.value,
                uid: localStorage.getItem('chatuid')
            })
            if (group.status === 200) {
                alert(`${group.data} created successfully`)
                groupform.style.display = 'none'
                groupname.value = ''
            } else {
                alert('Some error occured try again')
            }
        }

        async function getPrivateChat(e) {
            document.getElementById('addtogrp').style.display = 'none'
            const id = e.target.getAttribute('id')
            groupform.style.display = 'none'
            chatSectionHandler(id, e.target.innerHTML)

        }

        async function fetchGroups() {
            const g = await axios.get(`/chat/group/get`, {
                headers: {
                    uid: localStorage.getItem('chatuid')
                }
            })
            while (grplist.firstChild) {
                grplist.removeChild(grplist.firstChild)
            }

            const btn = document.createElement('button')
            btn.setAttribute('id', 0)
            btn.setAttribute('onclick', 'getPrivateChat(event)')
            btn.appendChild(document.createTextNode(`All Chat`))
            grplist.appendChild(btn)

            g.data.map(e => {
                const btn = document.createElement('button')
                btn.setAttribute('id', e.id)
                btn.setAttribute('onclick', 'getPrivateChat(event)')
                btn.appendChild(document.createTextNode(`${e.groupname}`))
                grplist.appendChild(btn)
            })
        }


        document.addEventListener('DOMContentLoaded', async () => {
            fetchGroups()
            if (!localStorage.getItem('chatuid')) window.location.href = '/'
            if (localStorage.getItem('chatHistory')) {
                const chats = JSON.parse(localStorage.getItem('chatHistory'))
                chats.map(e => {
                    createChatList(e.user.name, e.message)
                })
            }

            localStorage.setItem('chatgrpid', '0')

            chatSectionHandler(0, ' All Chat')


        })

        async function chatSectionHandler(grpid, grpname) {
            if (intval) clearInterval(intval)
            let allchats;
            try {
                intval = setInterval(async () => {
                    allchats = await axios.get(`/chat/${grpid}`, {
                        headers: {
                            uid: localStorage.getItem('chatuid')
                        }
                    })
                    localStorage.setItem('chatgrpid', `${grpid}`)
                    document.getElementById('chatwindowname').innerHTML = grpname
                    if (grpid != '0') {
                        document.getElementById('addbtn').style.display = 'block'
                    }
                    while (chatid.firstChild) {
                        chatid.removeChild(chatid.firstChild)
                    }
                    if (allchats.data.length > 0) {
                        allchats.data.reverse().map(e => {
                            return createChatList(e.user.name, e.message)
                        })
                    }
                }, 1000)
                if (grpid == '0') {
                    if (allchats && allchats.data.length > 0) {
                        localStorage.setItem('chatHistory', JSON.stringify(allchats.data))
                    }
                    const result = await axios.post(`/chat/allchat/0`, {
                        message: `has joined`,
                        uid: localStorage.getItem('chatuid')
                    })
                    if (result) {
                        createChatList(result.data.name, result.data.message)
                    }

                    document.getElementById('addbtn').style.display = 'none'

                }
            } catch (err) {
                console.log(err)
                alert('Some Error Ocuured')
                window.location.href = '/login'

            }
        }

        function createChatList(name, msg) {
            const li = document.createElement('li')
            li.appendChild(document.createTextNode(`${name} : ${msg}`))
            li.setAttribute('class', 'lst')
            chatid.appendChild(li)
        }

        async function allchatHandler(e) {
            e.preventDefault();
            if (allchat.value == '') {
                alert('Please write something')
                return
            }
            try {
                const result = await axios.post(`/chat/allchat/${localStorage.getItem('chatgrpid')}`, {
                    message: allchat.value,
                    uid: localStorage.getItem('chatuid')
                })
                if (result) {
                    allchat.value = ''
                    createChatList(result.data.name, result.data.message)
                }
            } catch (err) {
                alert('Some Error Ocuured')
            }
        }
    </script>
</body>

</html>